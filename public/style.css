// =======================
// دُرّى — واجهة مبسطة (سؤال نصي + زر سؤال صوتي خاص بنا)
// =======================

const API_BASE = "https://durra-server.onrender.com";

// ========= أدوات تنسيق الإجابة =========

// نهرب HTML عشان ما يصير أي إدخال خطير
function escapeHtml(s) {
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

// تحويل الأرقام 0-9 إلى أرقام عربية ٠١٢٣٤٥٦٧٨٩
function toArabicDigits(text) {
  const map = "٠١٢٣٤٥٦٧٨٩";
  return text.replace(/[0-9]/g, (d) => map[d]);
}

// تحويل المتغيرات والرموز إلى أسلوب عربي أقرب لمناهج الخليج
function localizeMathSymbols(text) {
  if (!text) return "";

  let t = text;

  // x كس متغير → س (مع محاولة تجنّب الكلمات الإنجليزية)
  // x مفردة لوحدها
  t = t.replace(/\bx\b/g, "س");
  // رقم متبوع بـ x مثل 2x
  t = t.replace(/(\d)\s*x\b/g, "$1س");
  // x قبل علامة تشغيل أو مساواة
  t = t.replace(/x(?=\s*[\+\-\*\/=)\]])/g, "س");

  // أوامر لاتِك شائعة
  t = t.replace(/\\cdot/g, " × ");
  t = t.replace(/\\sqrt/g, " √ ");

  // في النهاية نحول الأرقام إلى أرقام عربية
  t = toArabicDigits(t);

  return t;
}

// دالة تنظيف نص الإجابة من الرموز الزائدة (Markdown + LaTeX ثقيل)
function cleanAnswer(text) {
  if (!text) return "";
  let cleaned = text;

  // إزالة أي كود محصور بين ```
  cleaned = cleaned.replace(/```[\s\S]*?```/g, "");

  // إزالة عناوين Markdown (#, ##, ###) في بداية السطر
  cleaned = cleaned.replace(/^[ \t]*#{1,6}[ \t]*/gm, "");

  // إزالة النجوم ** من التنسيق
  cleaned = cleaned.replace(/\*\*/g, "");

  // إزالة الرموز \[ \] \( \)
  cleaned = cleaned.replace(/\\[\[\]\(\)]/g, "");

  // استبدال \\ بسطر جديد
  cleaned = cleaned.replace(/\\\\/g, "\n");

  // تبسيط مسافات متكررة
  cleaned = cleaned.replace(/[ \t]+/g, " ");

  // أسطر فارغة متكررة → سطرين فقط
  cleaned = cleaned.replace(/\n{3,}/g, "\n\n");

  // في النهاية نطبّق التعريب الرياضي (س، أرقام عربية، × …)
  cleaned = localizeMathSymbols(cleaned);

  return cleaned.trim();
}

// تحويل الكسور والأسس إلى HTML بشكل مرتب
function fractionsAndPowersToHtml(txt) {
  // 1) نهرب النص كله أولًا
  let t = escapeHtml(txt);

  // 2) نحول \frac{a}{b} إلى وسم جزء كسري مؤقت
  t = t.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, (_, a, b) => {
    return `[[FRAC:${escapeHtml(a)}|${escapeHtml(b)}]]`;
  });

  // 3) نحاول أيضًا تحويل صيغ a / b القصيرة إلى كسر
  t = t.replace(
    /(^|[\s(\[])([^()\s]{1,12})[ \t]*\/[ \t]*([^()\s]{1,12})(?=([\s)\].,!?؛،]|$))/g,
    (m, lead, A, B, tail) => {
      return `${lead}[[FRAC:${escapeHtml(A)}|${escapeHtml(B)}]]${tail || ""}`;
    }
  );

  // 4) نضيف placeholder للأسس: base^exp → [[POW:base|exp]]
  // نسمح بقاعدة قصيرة (رقم/س/قوس) وأس أس قصير
  t = t.replace(
    /(\d+|[٠١٢٣٤٥٦٧٨٩]+|س|\([^()]+\))\^([0-9٠١٢٣٤٥٦٧٨٩]+)/g,
    (m, base, exp) => {
      return `[[POW:${base}|${exp}]]`;
    }
